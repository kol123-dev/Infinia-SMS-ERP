name: Deploy Laravel school Erp

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3  

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Save SSH Private Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Sync changed files using rsync
        run: |
          rsync -avz --delete -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude='.env' \
          --exclude='storage/' \
          --exclude='.git/' \
          ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/Tesla01/web/sms.infiniasync.com/public_html/public/new-site/

      - name: Run Laravel deployment commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/sms.infiniasync.com/html/dssd/ss
            echo "Setting up Laravel..."
            
            # Setup permissions
            chown -R www-data:www-data .
            chmod -R 755 storage
            chmod -R 755 bootstrap/cache
            
            # Clear and cache
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear
            
            echo "Deployment complete!"